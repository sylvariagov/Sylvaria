<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sylvaria Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/179ab4bc4c.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
        }
        .card {
            background-color: #1f2937;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3), 0 4px 6px -2px rgba(0,0,0,0.25);
        }
        .nav-button.active {
            color: #38bdf8;
            border-bottom: 3px solid #38bdf8;
        }
        .like-button.liked {
            color: #38bdf8;
        }
        .profile-edit-modal input, .profile-edit-modal button, .profile-edit-modal textarea {margin-bottom:1rem;}
        #profile-pic-crop {max-width:100%;}
        .animate-fade-in { animation: fade-in 0.5s ease; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(12px);} to { opacity: 1; transform: none;} }
        .cursor-pointer {cursor:pointer;}
        .hidden {display:none;}
    </style>
</head>
<body class="bg-gray-900">

<header class="bg-gray-800 shadow-lg p-2 flex items-center sticky top-0 z-40">
    <!-- Left Section -->
    <div class="w-1/4">
        <h1 class="text-2xl font-bold text-sky-400 ml-4">Sylvaria Connect</h1>
    </div>

    <!-- Center Section (Nav Icons) -->
    <div id="header-nav-center" class="w-1/2 hidden md:flex justify-center items-center space-x-8">
        <a href="#" id="home-button" class="nav-button text-gray-300 hover:text-white active text-3xl px-6 py-2 rounded-lg"><i class="fas fa-home"></i></a>
        <a href="#" id="pages-button" class="nav-button text-gray-300 hover:text-white text-3xl px-6 py-2 rounded-lg"><i class="fas fa-file-alt"></i></a>
        <a href="#" id="groups-button" class="nav-button text-gray-300 hover:text-white text-3xl px-6 py-2 rounded-lg"><i class="fas fa-users"></i></a>
        <a href="#" id="friends-button" class="nav-button text-gray-300 hover:text-white text-3xl px-6 py-2 rounded-lg"><i class="fas fa-user-friends"></i></a>
    </div>

    <!-- Right Section -->
    <div id="header-nav-right" class="w-1/4 hidden md:flex justify-end items-center space-x-4 mr-4">
        <a href="#" id="notifications-button" class="nav-button text-gray-300 hover:text-white relative text-2xl"><i class="fas fa-bell"></i><span id="friend-request-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center"></span></a>
        <div id="user-menu" class="relative">
            <button id="user-menu-button" class="text-gray-300 hover:text-white"><i class="fas fa-user-circle text-3xl"></i></button>
            <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5">
                <a href="#" id="sign-out-button" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Sign Out</a>
            </div>
        </div>
    </div>
</header>

<main class="p-4 hidden" id="main-content">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="md:col-span-1">
            <div class="sticky top-20">
                <div id="profile-card-container"></div>
                <div class="card mt-4">
                    <h2 class="text-xl font-semibold mb-4">Friends</h2>
                    <div id="friends-list-container" class="space-y-4"></div>
                </div>
            </div>
        </div>
        <div class="md:col-span-2">
            <!-- Feed Page -->
            <div id="feed-page-container">
                <div id="stories-container" class="card mb-4"></div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Create a Post</h2>
                    <div id="feeling-display" class="hidden items-center mb-2 text-gray-400"></div>
                    <textarea id="post-content" class="w-full bg-gray-800 rounded-lg p-2" placeholder="What's on your mind?"></textarea>
                    <div id="media-preview-container" class="mt-4"></div>
                    <input type="file" id="media-upload-input" class="hidden" accept="image/*,video/*">
                    <div class="flex justify-between items-center mt-4">
                        <div class="flex space-x-4">
                            <button id="photo-button" class="text-gray-400 hover:text-sky-400"><i class="fas fa-image mr-2"></i>Photo/Video</button>
                            <button id="feeling-button" class="text-gray-400 hover:text-sky-400"><i class="fas fa-smile mr-2"></i>Feeling/Activity</button>
                        </div>
                        <button id="create-post-button" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Post</button>
                    </div>
                     <div class="flex items-center space-x-4 mt-3 text-sm text-gray-400">
                        <span>Post to:</span>
                        <label class="flex items-center"><input type="checkbox" id="post-visibility-feed" class="mr-1 bg-gray-700 border-gray-600 rounded" checked>Feed</label>
                        <label class="flex items-center"><input type="checkbox" id="post-visibility-page" class="mr-1 bg-gray-700 border-gray-600 rounded" checked>My Page</label>
                    </div>
                </div>
                <div class="card mt-4">
                    <h2 class="text-xl font-semibold mb-4">Feed</h2>
                    <div id="feed-container"></div>
                </div>
            </div>
            <!-- Groups Page -->
            <div id="groups-page-container" class="hidden"></div>
            <!-- Hashtag Page -->
            <div id="hashtag-page-container" class="hidden"></div>
            <!-- User's Page Container -->
            <div id="pages-page-container" class="hidden"></div>
            <!-- All Users Page -->
            <div id="all-users-page-container" class="hidden">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">All Users</h2>
                    <div id="all-users-container" class="space-y-4"></div>
                </div>
            </div>
            <!-- Notifications Page -->
            <div id="notifications-page-container" class="hidden">
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Friend Requests</h2>
                    <div id="friend-requests-container" class="space-y-4"></div>
                </div>
            </div>
        </div>
        <div class="md:col-span-1">
            <div class="sticky top-20">
                 <div class="card">
                    <h2 class="text-xl font-semibold mb-4">Chat</h2>
                    <div id="chat-widget"></div>
                </div>
            </div>
        </div>
    </div>
</main>

<div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 z-50 text-center p-4">
    <p class="text-gray-400 text-lg">Authenticating...</p>
</div>

<!-- Modals -->
<div id="story-viewer-modal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center">
    <button id="close-story-viewer" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
    <div id="story-content" class="relative h-full w-full max-w-lg flex items-center justify-center"></div>
    <button id="story-prev" class="absolute left-4 text-white text-4xl"><</button>
    <button id="story-next" class="absolute right-4 text-white text-4xl">></button>
</div>
<div id="create-story-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="card w-full max-w-lg relative">
        <button id="close-create-story-modal" class="absolute top-2 right-4 px-3 py-1 rounded-full bg-gray-600 text-white">&times;</button>
        <h2 class="text-xl font-semibold mb-4">Create a Story</h2>
        <input type="file" id="story-upload-input" class="hidden" accept="image/*,video/*">
        <div id="story-upload-preview" class="mb-4 h-80 bg-gray-800 rounded-lg flex items-center justify-center text-gray-400"></div>
        <div id="story-upload-error" class="text-red-400 mb-4"></div>
        <button id="post-story-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hidden">Post to Story</button>
    </div>
</div>
<div id="create-group-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="card w-full max-w-md relative">
        <button id="close-create-group-modal" class="absolute top-2 right-4 px-3 py-1 rounded-full bg-gray-600 text-white">&times;</button>
        <h2 class="text-xl font-semibold mb-4">Create a New Group</h2>
        <form id="create-group-form" class="space-y-4">
            <input type="text" id="group-name-input" required class="w-full bg-gray-800 rounded-lg p-2 text-white" placeholder="Group Name"/>
            <textarea id="group-description-input" class="w-full bg-gray-800 rounded-lg p-2 text-white" placeholder="Group Description"></textarea>
            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold">Create Group</button>
        </form>
        <div id="create-group-error" class="text-red-400 mt-2 text-center"></div>
    </div>
</div>
<div id="profile-edit-modal" class="profile-edit-modal hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="card w-full max-w-md relative">
        <button id="close-profile-edit" class="absolute top-2 right-4 px-3 py-1 rounded-full bg-gray-600 text-white">&times;</button>
        <h2 class="text-xl font-semibold mb-4">Edit Profile & Page</h2>
        <form id="profile-edit-form" class="space-y-4">
            <input type="text" id="display-name-edit" required class="w-full bg-gray-800 rounded-lg p-2 text-white" placeholder="Display Name"/>
            <label class="text-gray-400 text-sm">Page Description</label>
            <textarea id="page-description-edit" class="w-full bg-gray-800 rounded-lg p-2 text-white" placeholder="A short description for your page..."></textarea>
            <label class="text-gray-400 text-sm">About Me</label>
            <textarea id="about-me-edit" class="w-full bg-gray-800 rounded-lg p-2 text-white" placeholder="Tell everyone a little about yourself..."></textarea>
            <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold">Save Changes</button>
        </form>
        <div id="profile-edit-error" class="text-red-400 mt-2 text-center"></div>
    </div>
</div>
<div id="feeling-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="card w-full max-w-lg relative">
        <button id="close-feeling-modal" class="absolute top-2 right-4 px-3 py-1 rounded-full bg-gray-600 text-white">&times;</button>
        <h2 class="text-xl font-semibold mb-4">How are you feeling?</h2>
        <div id="emoji-grid" class="grid grid-cols-8 gap-4 text-3xl cursor-pointer mb-4"></div>
        <input type="text" id="activity-input" class="w-full bg-gray-800 rounded-lg p-2 text-white" placeholder="What are you doing? e.g., celebrating, watching a movie...">
        <div class="flex justify-end mt-4">
            <button id="save-feeling-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Done</button>
        </div>
    </div>
</div>
<div id="profile-pic-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="card w-full max-w-lg relative">
        <button id="close-pic-modal" class="absolute top-2 right-4 px-3 py-1 rounded-full bg-gray-600 text-white">&times;</button>
        <h2 class="text-xl font-semibold mb-4">Update Profile Picture</h2>
        <div class="text-center mb-4">
            <p class="text-gray-400">Upload a new image to crop.</p>
            <input type="file" id="profile-pic-upload-input" class="hidden" accept="image/*">
            <button id="select-image-btn" class="mt-2 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Select Image</button>
        </div>
        <div id="profile-pic-editor" class="hidden">
            <div class="mb-4 bg-gray-800 p-2 rounded-lg" style="height: 400px;">
                <img id="profile-pic-crop-image" src="" alt="Image for cropping">
            </div>
            <button id="save-profile-pic-btn" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold">Save Picture</button>
        </div>
        <div id="pic-upload-loading" class="hidden text-center"><p>Uploading...</p></div>
    </div>
</div>
<div id="cover-photo-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="card w-full max-w-4xl relative">
        <button id="close-cover-modal" class="absolute top-2 right-4 px-3 py-1 rounded-full bg-gray-600 text-white">&times;</button>
        <h2 class="text-xl font-semibold mb-4">Update Cover Photo</h2>
        <div class="text-center mb-4">
            <p class="text-gray-400">Upload a new image to crop.</p>
            <input type="file" id="cover-photo-upload-input" class="hidden" accept="image/*">
            <button id="select-cover-image-btn" class="mt-2 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Select Image</button>
        </div>
        <div id="cover-photo-editor" class="hidden">
            <div class="mb-4 bg-gray-800 p-2 rounded-lg" style="height: 400px;">
                <img id="cover-photo-crop-image" src="" alt="Image for cropping">
            </div>
            <button id="save-cover-photo-btn" class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg font-bold">Save Cover Photo</button>
        </div>
        <div id="cover-upload-loading" class="hidden text-center"><p>Uploading...</p></div>
    </div>
</div>
<div id="signup-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="w-full max-w-sm mx-auto bg-gray-800 p-8 rounded-2xl shadow-2xl animate-fade-in text-center relative">
        <button id="close-signup" class="absolute top-6 right-8 px-3 py-1 rounded-full bg-gray-600 text-white">&times;</button>
        <h2 class="mb-6 text-3xl font-bold text-sky-400">Sign Up</h2>
        <form id="signup-form" class="space-y-4 text-left">
            <input type="email" id="signup-email" required class="w-full bg-gray-700 p-3 rounded-lg text-white" placeholder="Email"/>
            <input type="password" id="signup-password" required class="w-full bg-gray-700 p-3 rounded-lg text-white" placeholder="Password"/>
            <input type="text" id="signup-display-name" required class="w-full bg-gray-700 p-3 rounded-lg text-white" placeholder="Display Name"/>
            <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 py-3 rounded-xl font-bold text-white">Sign Up</button>
        </form>
        <div id="signup-error" class="text-red-400 mt-4"></div>
    </div>
</div>

<script type="module">
    // --- Firebase imports & config ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
    import {
        getAuth, onAuthStateChanged, signOut,
        signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup,
        createUserWithEmailAndPassword, updateProfile
    } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, updateDoc, serverTimestamp as firestoreServerTimestamp, query, orderBy, onSnapshot, increment, arrayUnion, arrayRemove, where, deleteDoc } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";
    import { getDatabase, ref, onValue, onDisconnect, set, serverTimestamp as rtdbServerTimestamp, push } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js";

    const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/djkz4hbed/upload';
    const CLOUDINARY_UPLOAD_PRESET = 'zaybn6xt';

    const firebaseConfig = {
        apiKey: "AIzaSyB2NK-z6i74kTExGUE_ilN1jM8_oqEeSRs",
        authDomain: "sylvaria-universe.firebaseapp.com",
        projectId: "sylvaria-universe",
        storageBucket: "sylvaria-universe.firebasestorage.app",
        messagingSenderId: "256537971475",
        appId: "1:256537971475:web:baaac36786b918338428e6",
        measurementId: "G-4MCYL3VM15",
        databaseURL: "https://sylvaria-universe-default-rtdb.firebaseio.com",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const rtdb = getDatabase(app);

    let currentUserData = null;
    let allUsersCache = [];
    let friendsCache = [];
    let currentChatId = null;
    let chatUnsubscribe = null;
    let currentFeeling = null;
    let storiesCache = [];
    let storyUnsubscribe = null;

    // -------- LOGIN, SIGNUP, PROFILE EDIT --------
    function showLoginForm() {
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('header-nav-center').classList.add('hidden');
        document.getElementById('header-nav-right').classList.add('hidden');
        document.getElementById('loading-screen').innerHTML = `
            <div class="w-full max-w-sm mx-auto bg-gray-800 p-8 rounded-2xl shadow-2xl animate-fade-in text-center relative h-screen flex flex-col justify-center">
                <div>
                    <h2 class="mb-6 text-3xl font-bold text-sky-400">Sign In</h2>
                    <button id="google-login-btn" class="w-full flex items-center justify-center bg-white text-gray-900 py-3 rounded-xl font-semibold text-lg shadow hover:scale-[1.03] hover:shadow-lg transition mb-6 border border-gray-300">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="w-6 h-6 mr-2 -ml-2"> Continue with Google
                    </button>
                    <div class="flex items-center my-4">
                        <div class="flex-grow border-t border-gray-600"></div>
                        <span class="mx-3 text-gray-400 font-medium">or</span>
                        <div class="flex-grow border-t border-gray-600"></div>
                    </div>
                    <form id="login-form" class="space-y-4 text-left">
                        <div>
                            <label for="login-email" class="block text-sm text-gray-400 font-semibold mb-1">Email</label>
                            <input type="email" id="login-email" required class="w-full bg-gray-700 p-3 rounded-lg text-white border-2 border-gray-700 focus:border-sky-400 transition" placeholder="Email" autocomplete="email" />
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm text-gray-400 font-semibold mb-1">Password</label>
                            <input type="password" id="login-password" required class="w-full bg-gray-700 p-3 rounded-lg text-white border-2 border-gray-700 focus:border-sky-400 transition" placeholder="Password" autocomplete="current-password" />
                        </div>
                        <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 py-3 rounded-xl font-bold text-white shadow transition">Sign In</button>
                    </form>
                    <button id="go-signup" class="w-full mt-2 bg-green-600 hover:bg-green-700 py-3 rounded-xl font-bold text-white shadow transition">Create Account</button>
                    <div id="login-error" class="text-red-400 mt-4 font-semibold text-center"></div>
                    <div id="login-loading" class="hidden mt-6 flex justify-center"><svg class="animate-spin h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-30" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-80" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/></svg></div>
                </div>
                <a href="launchpad.html" class="text-gray-400 hover:text-white text-sm absolute bottom-4 left-4"><i class="fas fa-rocket mr-2"></i>Launchpad</a>
            </div>
        `;
        document.getElementById('loading-screen').classList.remove('hidden');
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('login-error').textContent = '';
            document.getElementById('login-loading').classList.remove('hidden');
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                document.getElementById('login-loading').classList.add('hidden');
                document.getElementById('login-error').textContent = err.message;
            }
        });
        document.getElementById('google-login-btn').addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (err) {
                document.getElementById('login-error').textContent = err.message;
            }
        });
        document.getElementById('go-signup').addEventListener('click', () => {
            document.getElementById('signup-modal').classList.remove('hidden');
        });
    }

    document.getElementById('signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const displayName = document.getElementById('signup-display-name').value;
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await updateProfile(userCredential.user, {displayName});
            await setDoc(doc(db, "users", userCredential.user.uid), {
                displayName,
                email,
                photoURL: userCredential.user.photoURL || `https://api.dicebear.com/7.x/initials/svg?seed=${userCredential.user.uid}`,
                coverPhotoURL: '',
                createdAt: new Date().toISOString(),
                friends: [],
                friendRequestsSent: [],
                friendRequestsReceived: [],
                blockedUsers: [],
                posts: 0,
                pageDescription: '',
                aboutMe: '',
                pinnedPost: null
            });
            document.getElementById('signup-modal').classList.add('hidden');
        } catch (err) {
            document.getElementById('signup-error').textContent = err.message;
        }
    });
    document.getElementById('close-signup').addEventListener('click', () => {
        document.getElementById('signup-modal').classList.add('hidden');
    });

    // -------- MAIN AUTH STATE + APP UI LOGIC --------
    onAuthStateChanged(auth, async (user) => {
        const mainContent = document.getElementById('main-content');
        const loadingScreen = document.getElementById('loading-screen');

        if (user) {
            loadingScreen.innerHTML = '<p class="text-gray-400 text-lg">Loading your universe...</p>';
            try {
                const userRef = doc(db, "users", user.uid);
                
                // Set up live listeners
                onSnapshot(userRef, (docSnap) => {
                    currentUserData = docSnap.data();
                    if (!currentUserData) return;
                    renderProfileCard(currentUserData, true);
                    renderFriendsList(currentUserData.friends || []);
                    updateFriendRequestBadge(currentUserData.friendRequestsReceived || []);
                    // Only render my page if it's the active view
                    if(document.getElementById('pages-page-container').dataset.userId === auth.currentUser.uid) {
                        renderUserPage(auth.currentUser.uid)
                    }
                });

                onSnapshot(collection(db, "users"), (snapshot) => {
                    allUsersCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    if(!document.getElementById('all-users-page-container').classList.contains('hidden')) renderAllUsers();
                });

                // Initial setup
                let userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        displayName: user.displayName || 'New User',
                        email: user.email,
                        photoURL: user.photoURL || `https://api.dicebear.com/7.x/initials/svg?seed=${user.uid}`,
                        coverPhotoURL: '',
                        createdAt: new Date().toISOString(),
                        friends: [], friendRequestsSent: [], friendRequestsReceived: [],
                        blockedUsers: [],
                        posts: 0, pageDescription: '', aboutMe: '',
                        pinnedPost: null
                    });
                }

                setupNavigation();
                setupPostCreation();
                setupFeed();
                setupFriendAndUserPages();
                setupNotifications();
                setupProfileEditing();
                setupChat();
                setupUserMenu();
                setupProfilePictureEditing();
                setupCoverPhotoEditing();
                setupFeelingModal();
                setupStories();
                setupGroups();

                document.getElementById('header-nav-center').classList.remove('hidden');
                document.getElementById('header-nav-right').classList.remove('hidden');
                mainContent.classList.remove('hidden');
                loadingScreen.classList.add('hidden');

            } catch (error) {
                console.error("Authentication Error:", error);
                loadingScreen.innerHTML = `<p class="text-red-400">Error: ${error.message}</p><button id="logout-error-button" class="mt-6 bg-sky-500 text-white font-bold py-2 px-4 rounded-lg">Sign Out</button>`;
                document.getElementById('logout-error-button').onclick = () => signOut(auth);
            }
        } else {
            showLoginForm();
            mainContent.classList.add('hidden');
            loadingScreen.classList.remove('hidden');
        }
    });

    // --- UI RENDERING FUNCTIONS ---
    function renderProfileCard(userData, isCurrentUserPage) {
        const profileCardContainer = document.getElementById('profile-card-container');
        let cardHTML = `
            <div class="card text-center relative">
                <div id="profile-pic-container" class="w-24 h-24 rounded-full mx-auto bg-gray-700 mb-4 overflow-hidden relative group ${isCurrentUserPage ? 'cursor-pointer' : ''}">
                    <img src="${userData.photoURL}" alt="Profile Picture" class="w-full h-full object-cover">
                    ${isCurrentUserPage ? `
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-camera text-white text-2xl"></i>
                    </div>` : ''}
                </div>
                <h2 class="text-xl font-semibold">${userData.displayName}</h2>
                <p class="text-gray-400">${userData.email}</p>
                <div class="flex justify-around mt-4 border-t border-gray-700 pt-4">
                    <div><p class="font-bold text-lg">${userData.posts || 0}</p><p class="text-gray-400 text-sm">Posts</p></div>
                    <div><p class="font-bold text-lg">${(userData.friends || []).length}</p><p class="text-gray-400 text-sm">Friends</p></div>
                </div>
                ${isCurrentUserPage ? `<button id="edit-profile-btn" class="mt-4 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Edit Profile</button>` : ''}
            </div>`;

        profileCardContainer.innerHTML = cardHTML;

        if (isCurrentUserPage) {
            document.getElementById('profile-pic-container').onclick = () => {
                document.getElementById('profile-pic-modal').classList.remove('hidden');
            };
            document.getElementById('edit-profile-btn').onclick = () => openProfileEditModal(userData);
        }
    }

    async function renderFriendsList(friendIds) {
        const friendsListContainer = document.getElementById('friends-list-container');
        friendsListContainer.innerHTML = '';
        if (!friendIds || friendIds.length === 0) {
            friendsListContainer.innerHTML = `<p class="text-gray-400">No friends yet.</p>`;
            return;
        }
        const friendPromises = friendIds.map(id => getDoc(doc(db, 'users', id)));
        const friendSnaps = await Promise.all(friendPromises);
        friendsCache = friendSnaps.map(snap => ({ id: snap.id, ...snap.data() }));
        friendsCache.forEach(friend => {
            const friendElement = document.createElement('div');
            friendElement.className = 'flex items-center justify-between';
            friendElement.innerHTML = `
                <div class="flex items-center">
                    <img src="${friend.photoURL}" class="w-10 h-10 rounded-full object-cover">
                    <p class="ml-3 font-semibold">${friend.displayName}</p>
                </div>
                <button data-uid="${friend.id}" class="view-user-page-btn bg-sky-500 hover:bg-sky-600 text-white text-xs font-bold py-1 px-2 rounded">View Page</button>
            `;
            friendsListContainer.appendChild(friendElement);
        });
        // Re-render chat UI to update dropdown
        setupChat();
    }

    function updateFriendRequestBadge(requests) {
        const badge = document.getElementById('friend-request-badge');
        if (requests.length > 0) {
            badge.textContent = requests.length;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    function renderAllUsers() {
        const allUsersContainer = document.getElementById('all-users-container');
        allUsersContainer.innerHTML = '';
        const otherUsers = allUsersCache.filter(u => u.id !== auth.currentUser.uid && !currentUserData.blockedUsers?.includes(u.id));
        if (otherUsers.length === 0) {
            allUsersContainer.innerHTML = `<p class="text-gray-400">No other users found.</p>`;
            return;
        }
        otherUsers.forEach(otherUser => {
            const userElement = document.createElement('div');
            userElement.className = 'flex items-center justify-between';
            let buttonHtml;
            if (currentUserData.friends?.includes(otherUser.id)) {
                buttonHtml = `<button disabled class="bg-gray-500 text-white py-2 px-4 rounded-lg">Friends</button>`;
            } else if (currentUserData.friendRequestsSent?.includes(otherUser.id)) {
                buttonHtml = `<button disabled class="bg-gray-500 text-white py-2 px-4 rounded-lg">Request Sent</button>`;
            } else if (currentUserData.friendRequestsReceived?.includes(otherUser.id)) {
                buttonHtml = `<button data-uid="${otherUser.id}" class="accept-friend-button bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg">Accept</button>`;
            } else {
                buttonHtml = `<button data-uid="${otherUser.id}" class="add-friend-button bg-sky-500 hover:bg-sky-600 text-white py-2 px-4 rounded-lg">Add Friend</button>`;
            }
            userElement.innerHTML = `<div class="flex items-center"><img src="${otherUser.photoURL}" class="w-12 h-12 rounded-full"><div class="ml-4"><p class="font-semibold">${otherUser.displayName}</p><p class="text-xs text-gray-400">${otherUser.email || ''}</p></div></div>${buttonHtml}`;
            allUsersContainer.appendChild(userElement);
        });
    }

    async function renderUserPage(userId) {
        const isCurrentUser = userId === auth.currentUser.uid;
        const pageContainer = document.getElementById('pages-page-container');
        pageContainer.innerHTML = `<div class="card">Loading...</div>`;
        pageContainer.dataset.userId = userId; // Keep track of whose page this is

        const userDoc = await getDoc(doc(db, 'users', userId));
        if (!userDoc.exists()) {
            pageContainer.innerHTML = `<div class="card">User not found.</div>`;
            return;
        }
        const userData = userDoc.data();

        const coverPhotoUrl = userData.coverPhotoURL || 'https://images.unsplash.com/photo-1531297484001-80022131f5a1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2020&q=80';

        pageContainer.innerHTML = `
            <div class="card p-0 overflow-hidden relative">
                 <div class="h-48 bg-gray-700 relative group" id="cover-photo-container">
                    <img src="${coverPhotoUrl}" class="w-full h-full object-cover"/>
                    ${isCurrentUser ? `<button id="change-cover-btn" class="absolute top-4 right-4 bg-black bg-opacity-50 text-white py-1 px-3 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-camera mr-2"></i>Change Cover</button>` : ''}
                </div>
                <div class="p-6 pt-0">
                    <div class="card text-center relative p-0">
                         <div class="w-24 h-24 rounded-full mx-auto bg-gray-700 mb-4 overflow-hidden relative -mt-12 border-4 border-gray-800 z-10 ${isCurrentUser ? 'group cursor-pointer' : ''}" ${isCurrentUser ? 'id="profile-pic-container"' : ''}>
                            <img src="${userData.photoURL}" alt="Profile Picture" class="w-full h-full object-cover">
                            ${isCurrentUser ? `<div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-camera text-white text-2xl"></i></div>` : ''}
                         </div>
                         <div class="p-6 pt-2">
                            <h2 class="text-xl font-semibold">${userData.displayName}</h2>
                            <p class="text-gray-400">${userData.pageDescription || ''}</p>
                            <div class="flex justify-around mt-4 border-t border-gray-700 pt-4">
                                <div><p class="font-bold text-lg">${userData.posts || 0}</p><p class="text-gray-400 text-sm">Posts</p></div>
                                <div><p class="font-bold text-lg">${(userData.friends || []).length}</p><p class="text-gray-400 text-sm">Friends</p></div>
                            </div>
                            ${isCurrentUser ? `<button id="edit-profile-btn" class="mt-4 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Edit Profile</button>` : ''}
                         </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="flex border-b border-gray-700 mb-4">
                    <button class="page-tab-btn active text-lg font-semibold py-2 px-4" data-tab="posts">Posts</button>
                    <button class="page-tab-btn text-lg font-semibold py-2 px-4" data-tab="about">About</button>
                    <button class="page-tab-btn text-lg font-semibold py-2 px-4" data-tab="photos">Photos</button>
                </div>
                <div id="page-content-container">
                    <div id="page-posts-container"></div>
                    <div id="page-about-container" class="hidden"></div>
                    <div id="page-photos-container" class="hidden"></div>
                </div>
            </div>`;

        if (isCurrentUser) {
            document.getElementById('change-cover-btn').onclick = () => document.getElementById('cover-photo-modal').classList.remove('hidden');
            document.getElementById('profile-pic-container').onclick = () => document.getElementById('profile-pic-modal').classList.remove('hidden');
            document.getElementById('edit-profile-btn').onclick = () => openProfileEditModal(userData);
        }

        const tabButtons = pageContainer.querySelectorAll('.page-tab-btn');
        const tabContainers = {
            posts: document.getElementById('page-posts-container'),
            about: document.getElementById('page-about-container'),
            photos: document.getElementById('page-photos-container'),
        };

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                Object.values(tabContainers).forEach(c => c.classList.add('hidden'));
                tabContainers[button.dataset.tab].classList.remove('hidden');
            });
        });

        loadUserPosts(tabContainers.posts, userId, userData.pinnedPost);
        loadUserAbout(tabContainers.about, userData);
        loadUserPhotos(tabContainers.photos, userId);
    }

    async function loadUserPosts(container, userId, pinnedPostId) {
        container.innerHTML = '';
        if (pinnedPostId) {
            const pinnedPostRef = doc(db, "posts", pinnedPostId);
            const pinnedPostSnap = await getDoc(pinnedPostRef);
            if (pinnedPostSnap.exists()) {
                const pinnedPostEl = renderPostElement(pinnedPostSnap.id, pinnedPostSnap.data(), true);
                container.appendChild(pinnedPostEl);
            }
        }

        const q = query(collection(db, "posts"), where("authorId", "==", userId), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const regularPosts = snapshot.docs.filter(doc => doc.id !== pinnedPostId);
            if (regularPosts.length === 0 && !pinnedPostId) {
                container.innerHTML = `<p class="text-gray-400">This user hasn't posted anything yet.</p>`;
                return;
            }
            regularPosts.forEach(postDoc => {
                if (!document.getElementById(postDoc.id)) { // Avoid duplicates
                    container.appendChild(renderPostElement(postDoc.id, postDoc.data()));
                }
            });
        });
    }

    function loadUserAbout(container, userData) {
        const aboutMeText = userData.aboutMe || (userData.id === auth.currentUser.uid ? 'Nothing here yet. Click \'Edit Profile\' to add something.' : 'Nothing to see here.');
        container.innerHTML = `
            <div class="mb-6">
                <h3 class="text-xl font-semibold">About Me</h3>
                <p class="text-gray-300 mt-2">${aboutMeText}</p>
            </div>
        `;
    }

    function loadUserPhotos(container, userId) {
        const q = query(collection(db, "posts"), where("authorId", "==", userId), where("mediaType", "==", "image"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            container.innerHTML = '';
            if (snapshot.empty) {
                container.innerHTML = `<p class="text-gray-400">No photos to display.</p>`;
                return;
            }
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-3 gap-1';
            snapshot.forEach(doc => {
                const post = doc.data();
                const img = document.createElement('img');
                img.src = post.mediaUrl;
                img.className = 'w-full h-full object-cover aspect-square cursor-pointer';
                grid.appendChild(img);
            });
            container.appendChild(grid);
        });
    }

    function renderPostElement(postId, post, isPinned = false) {
        const postElement = document.createElement('div');
        postElement.className = 'border-t border-gray-700 pt-4 mt-4';
        postElement.id = postId;

        const postDate = post.createdAt?.toDate?.() ? post.createdAt.toDate().toLocaleString() : 'Just now';
        let mediaHTML = '';
        if (post.mediaUrl) {
            mediaHTML = post.mediaType?.startsWith('video')
                ? `<video src="${post.mediaUrl}" class="mt-4 rounded-lg w-full" controls></video>`
                : `<img src="${post.mediaUrl}" class="mt-4 rounded-lg max-h-96 w-full object-cover">`;
        }

        const reactions = post.reactions || {};
        const userReaction = reactions[auth.currentUser.uid];

        let feelingHTML = '';
        if (post.feeling) {
            feelingHTML = `<span class="text-gray-400 ml-1">— is feeling ${post.feeling.emoji} ${post.feeling.text}</span>`;
        }

        const contentWithHashtags = post.content.replace(/#(\w+)/g, '<a href="#" class="hashtag-link text-sky-400 hover:underline" data-hashtag="$1">#$1</a>');

        let reactionButtonHTML = `
            <div class="like-button-container relative">
                <button data-post-id="${postId}" class="like-button hover:text-sky-400 flex items-center ${userReaction ? 'liked' : ''}">
                    <i class="fas fa-thumbs-up mr-2"></i>
                    <span>${Object.keys(reactions).length}</span>
                </button>
                <div class="reactions-container absolute bottom-full mb-2 flex space-x-2 bg-gray-800 p-2 rounded-full shadow-lg hidden">
                    <button data-post-id="${postId}" data-reaction="like" class="reaction-button text-2xl">👍</button>
                    <button data-post-id="${postId}" data-reaction="love" class="reaction-button text-2xl">❤️</button>
                    <button data-post-id="${postId}" data-reaction="haha" class="reaction-button text-2xl">😂</button>
                    <button data-post-id="${postId}" data-reaction="wow" class="reaction-button text-2xl">😮</button>
                    <button data-post-id="${postId}" data-reaction="sad" class="reaction-button text-2xl">😢</button>
                    <button data-post-id="${postId}" data-reaction="angry" class="reaction-button text-2xl">😠</button>
                </div>
            </div>`;

        postElement.innerHTML = `
            <div class="flex items-start">
                <img src="${post.authorPhotoURL}" alt="${post.authorName}" class="w-12 h-12 rounded-full">
                <div class="ml-4 flex-grow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold">${post.authorName}</h3>
                            ${feelingHTML}
                            <span class="text-gray-400 text-sm ml-2">&middot; ${postDate}</span>
                        </div>
                        <div class="relative post-options-container">
                            <button class="post-options-btn text-gray-400 hover:text-white"><i class="fas fa-ellipsis-h"></i></button>
                            <div class="post-options-menu hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5">
                                ${post.authorId === auth.currentUser.uid ? `<a href="#" class="pin-post-btn block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700" data-post-id="${postId}">${isPinned ? 'Unpin Post' : 'Pin Post'}</a>` : ''}
                                <a href="#" class="block-user-btn block px-4 py-2 text-sm text-red-400 hover:bg-gray-700" data-uid="${post.authorId}">Block User</a>
                            </div>
                        </div>
                    </div>
                    <p class="mt-1">${contentWithHashtags}</p>
                    ${mediaHTML}
                    <div class="mt-4 flex items-center text-gray-400">
                        ${reactionButtonHTML}
                        <button data-post-id="${postId}" class="comment-button hover:text-sky-400 ml-4"><i class="fas fa-comment mr-2"></i>${post.commentCount || 0}</button>
                        <button data-post-content="${post.content}" class="share-button hover:text-sky-400 ml-4"><i class="fas fa-share mr-2"></i>Share</button>
                    </div>
                    <div class="comments-section mt-4 space-y-4 hidden" id="comments-section-${postId}"></div>
                </div>
            </div>`;
        return postElement;
    }

    // --- FEATURE SETUP FUNCTIONS ---
    function setupNavigation() {
        const pages = {
            feed: document.getElementById('feed-page-container'),
            groups: document.getElementById('groups-page-container'),
            hashtag: document.getElementById('hashtag-page-container'),
            mypage: document.getElementById('pages-page-container'),
            users: document.getElementById('all-users-page-container'),
            notifications: document.getElementById('notifications-page-container')
        };
        const navButtons = {
            feed: document.getElementById('home-button'),
            groups: document.getElementById('groups-button'),
            mypage: document.getElementById('pages-button'),
            users: document.getElementById('friends-button'),
            notifications: document.getElementById('notifications-button')
        };

        function showPage(pageKey) {
            Object.values(pages).forEach(p => p.classList.add('hidden'));
            Object.values(navButtons).forEach(b => b.classList.remove('active'));
            
            const targetPage = pages[pageKey];
            if (targetPage) {
                targetPage.classList.remove('hidden');
            }

            const targetButton = navButtons[pageKey];
            if(targetButton) {
                targetButton.classList.add('active');
            }

            // Special handling for pages
            if (pageKey === 'mypage') {
                renderUserPage(auth.currentUser.uid);
                renderProfileCard(currentUserData, true);
            } else {
                renderProfileCard(currentUserData, false);
            }

            if (pageKey === 'users') renderAllUsers();
            if (pageKey === 'notifications') displayFriendRequests();
            if (pageKey === 'groups') renderGroupsPage();
        }

        window.showPage = showPage;
        window.renderUserPage = renderUserPage;

        navButtons.feed.onclick = (e) => { e.preventDefault(); showPage('feed'); };
        navButtons.mypage.onclick = (e) => { e.preventDefault(); showPage('mypage'); };
        navButtons.users.onclick = (e) => { e.preventDefault(); showPage('users'); };
        navButtons.notifications.onclick = (e) => { e.preventDefault(); showPage('notifications'); };
        navButtons.groups.onclick = (e) => { e.preventDefault(); showPage('groups'); };
    }

    function setupPostCreation() {
        const createPostBtn = document.getElementById('create-post-button');
        const postContent = document.getElementById('post-content');
        const mediaPreviewContainer = document.getElementById('media-preview-container');
        let uploadedMedia = null;

        document.getElementById('photo-button').onclick = () => document.getElementById('media-upload-input').click();
        document.getElementById('media-upload-input').onchange = async (e) => {
            if (!e.target.files[0]) return;
            const file = e.target.files[0];
            const formData = new FormData();
            formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            mediaPreviewContainer.innerHTML = `<p class="text-gray-400">Uploading...</p>`;
            try {
                const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await res.json();
                uploadedMedia = { url: data.secure_url, type: data.resource_type };
                mediaPreviewContainer.innerHTML = data.resource_type.startsWith('video')
                    ? `<video src="${uploadedMedia.url}" class="rounded-lg max-h-40 mx-auto" controls></video>`
                    : `<img src="${uploadedMedia.url}" class="rounded-lg max-h-40 mx-auto">`;
            } catch (err) { mediaPreviewContainer.innerHTML = `<p class="text-red-400">Upload failed.</p>`; uploadedMedia = null; }
        };

        createPostBtn.onclick = async () => {
            const content = postContent.value.trim();
            const postToFeed = document.getElementById('post-visibility-feed').checked;
            const postToPage = document.getElementById('post-visibility-page').checked;
            const visibility = [];
            if (postToFeed) visibility.push('feed');
            if (postToPage) visibility.push('page');

            if ((!content && !uploadedMedia) || visibility.length === 0) return;

            const hashtags = content.match(/#(\w+)/g)?.map(h => h.substring(1)) || [];

            try {
                await addDoc(collection(db, 'posts'), {
                    authorId: auth.currentUser.uid,
                    authorName: currentUserData.displayName,
                    authorPhotoURL: currentUserData.photoURL,
                    content: content,
                    feeling: currentFeeling,
                    hashtags: hashtags,
                    mediaUrl: uploadedMedia?.url || '',
                    mediaType: uploadedMedia?.type || '',
                    createdAt: firestoreServerTimestamp(),
                    reactions: {},
                    commentCount: 0,
                    visibility: visibility
                });
                await updateDoc(doc(db, "users", auth.currentUser.uid), { posts: increment(1) });
                postContent.value = '';
                mediaPreviewContainer.innerHTML = '';
                uploadedMedia = null;
                currentFeeling = null;
                document.getElementById('feeling-display').classList.add('hidden');
            } catch (error) { console.error("Error creating post:", error); }
        };
    }

    function setupFeed() {
        const feedContainer = document.getElementById('feed-container');
        const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            feedContainer.innerHTML = '';
            const feedPosts = snapshot.docs.filter(doc => {
                const postData = doc.data();
                const isBlocked = currentUserData.blockedUsers?.includes(postData.authorId);
                return !isBlocked && (postData.visibility === undefined || postData.visibility.includes('feed'));
            });

            if (feedPosts.length === 0) {
                feedContainer.innerHTML = `<p class="text-gray-400">No posts yet. Be the first!</p>`;
                return;
            }
            feedPosts.forEach(postDoc => {
                feedContainer.appendChild(renderPostElement(postDoc.id, postDoc.data()));
            });
        });

        document.body.addEventListener('click', handlePostInteraction);
    }

    function setupFriendAndUserPages() {
        document.getElementById('friends-list-container').addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.view-user-page-btn');
            if (viewBtn) {
                const userId = viewBtn.dataset.uid;
                showPage('mypage'); // Switch to the page container view
                renderUserPage(userId);
            }
        });

        const allUsersContainer = document.getElementById('all-users-container');
        allUsersContainer.addEventListener('click', async (e) => {
            const uid = e.target.dataset.uid;
            if (!uid) return;
            if (e.target.classList.contains('add-friend-button')) {
                await updateDoc(doc(db, 'users', auth.currentUser.uid), { friendRequestsSent: arrayUnion(uid) });
                await updateDoc(doc(db, 'users', uid), { friendRequestsReceived: arrayUnion(auth.currentUser.uid) });
            }
            if (e.target.classList.contains('accept-friend-button')) {
                await acceptFriendRequest(uid);
            }
        });
    }

    async function acceptFriendRequest(senderId) {
        const userRef = doc(db, 'users', auth.currentUser.uid);
        const senderRef = doc(db, 'users', senderId);
        await updateDoc(userRef, { friends: arrayUnion(senderId), friendRequestsReceived: arrayRemove(senderId) });
        await updateDoc(senderRef, { friends: arrayUnion(auth.currentUser.uid), friendRequestsSent: arrayRemove(senderId) });
        displayFriendRequests();
    }

    async function displayFriendRequests() {
        const container = document.getElementById('friend-requests-container');
        container.innerHTML = '';
        const received = currentUserData.friendRequestsReceived || [];
        if (received.length === 0) {
            container.innerHTML = `<p class="text-gray-400">No new friend requests.</p>`;
            return;
        }
        const senderPromises = received.map(id => getDoc(doc(db, 'users', id)));
        const senderSnaps = await Promise.all(senderPromises);
        senderSnaps.forEach(senderSnap => {
            if (!senderSnap.exists()) return;
            const senderData = senderSnap.data();
            const reqEl = document.createElement('div');
            reqEl.className = 'flex items-center justify-between';
            reqEl.innerHTML = `
                <div class="flex items-center"><img src="${senderData.photoURL}" class="w-12 h-12 rounded-full"><p class="ml-4 font-semibold">${senderData.displayName}</p></div>
                <div>
                    <button data-uid="${senderSnap.id}" class="accept-friend-button bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg">Accept</button>
                    <button data-uid="${senderSnap.id}" class="decline-friend-button bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg ml-2">Decline</button>
                </div>`;
            container.appendChild(reqEl);
        });
    }

    function setupNotifications() {
        const container = document.getElementById('notifications-page-container');
        container.addEventListener('click', async (e) => {
            const uid = e.target.dataset.uid;
            if (!uid) return;
            if (e.target.classList.contains('accept-friend-button')) {
                await acceptFriendRequest(uid);
            }
            if (e.target.classList.contains('decline-friend-button')) {
                const userRef = doc(db, 'users', auth.currentUser.uid);
                const senderRef = doc(db, 'users', uid);
                await updateDoc(userRef, { friendRequestsReceived: arrayRemove(uid) });
                await updateDoc(senderRef, { friendRequestsSent: arrayRemove(auth.currentUser.uid) });
                displayFriendRequests();
            }
        });
    }

    function setupProfileEditing() {
        const modal = document.getElementById('profile-edit-modal');
        document.getElementById('close-profile-edit').onclick = () => modal.classList.add('hidden');
        document.getElementById('profile-edit-form').onsubmit = async (e) => {
            e.preventDefault();
            const newDisplayName = document.getElementById('display-name-edit').value;
            const newPageDesc = document.getElementById('page-description-edit').value;
            const newAboutMe = document.getElementById('about-me-edit').value;
            try {
                await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                    displayName: newDisplayName,
                    pageDescription: newPageDesc,
                    aboutMe: newAboutMe
                });
                await updateProfile(auth.currentUser, { displayName: newDisplayName });
                modal.classList.add('hidden');
            } catch (err) {
                document.getElementById('profile-edit-error').textContent = err.message;
            }
        };
    }

    function openProfileEditModal(userData) {
        document.getElementById('display-name-edit').value = userData.displayName;
        document.getElementById('page-description-edit').value = userData.pageDescription || '';
        document.getElementById('about-me-edit').value = userData.aboutMe || '';
        document.getElementById('profile-edit-modal').classList.remove('hidden');
    }

    function setupChat() {
        const chatWidget = document.getElementById('chat-widget');

        let options = friendsCache.map(f => `<option value="${f.id}">${f.displayName}</option>`).join('');
        chatWidget.innerHTML = `
            <select id="chat-friend-select" class="w-full bg-gray-800 rounded-lg p-2 mb-2">
                <option value="">Select a friend to chat...</option>
                ${options}
            </select>
            <div id="chat-messages" class="h-64 overflow-y-auto bg-gray-800 rounded-lg p-2 mb-2"></div>
            <div class="flex">
                <input type="text" id="chat-input" placeholder="Type a message..." class="w-full bg-gray-800 rounded-l-lg p-2" disabled>
                <button id="chat-send-btn" class="bg-sky-500 hover:bg-sky-600 text-white px-4 rounded-r-lg" disabled>Send</button>
            </div>
        `;
        document.getElementById('chat-friend-select').onchange = (e) => openChat(e.target.value);
        document.getElementById('chat-send-btn').onclick = sendMessage;
        document.getElementById('chat-input').onkeyup = (e) => { if(e.key === 'Enter') sendMessage(); };

        function openChat(friendId) {
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');

            if (chatUnsubscribe) chatUnsubscribe();

            if (!friendId) {
                chatMessages.innerHTML = '<p class="text-gray-400 text-center">Select a friend to start chatting.</p>';
                chatInput.disabled = true;
                chatSendBtn.disabled = true;
                currentChatId = null;
                return;
            }
            
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
            const members = [auth.currentUser.uid, friendId].sort();
            currentChatId = members.join('_');
            const chatMessagesRef = ref(rtdb, `chats/${currentChatId}/messages`);
            
            chatUnsubscribe = onValue(chatMessagesRef, (snapshot) => {
                chatMessages.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnap => {
                        const msg = childSnap.val();
                        const msgEl = document.createElement('div');
                        const isSender = msg.senderId === auth.currentUser.uid;
                        msgEl.className = `p-2 my-1 rounded-lg text-white text-sm ${isSender ? 'bg-sky-600 ml-auto' : 'bg-gray-600 mr-auto'}`;
                        msgEl.style.maxWidth = '80%';
                        msgEl.textContent = msg.text;
                        chatMessages.appendChild(msgEl);
                    });
                } else {
                    chatMessages.innerHTML = '<p class="text-gray-400 text-center">No messages yet. Say hi!</p>';
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text && currentChatId) {
                const chatMessagesRef = ref(rtdb, `chats/${currentChatId}/messages`);
                push(chatMessagesRef, {
                    senderId: auth.currentUser.uid,
                    text: text,
                    timestamp: rtdbServerTimestamp()
                });
                input.value = '';
            }
        }
    }

    async function handlePostInteraction(e) {
        const user = auth.currentUser;
        if (!user) return;

        const likeButton = e.target.closest('.like-button');
        if (likeButton) {
            const reactionsContainer = likeButton.closest('.like-button-container').querySelector('.reactions-container');
            if (reactionsContainer) {
                reactionsContainer.classList.toggle('hidden');
            }
        }

        const reactionButton = e.target.closest('.reaction-button');
        if (reactionButton) {
            const postId = reactionButton.dataset.postId;
            const reaction = reactionButton.dataset.reaction;
            const postRef = doc(db, 'posts', postId);
            
            const postSnap = await getDoc(postRef);
            if (postSnap.exists()) {
                let reactions = postSnap.data().reactions || {};
                if (reactions[user.uid] === reaction) {
                    delete reactions[user.uid];
                } else { 
                    reactions[user.uid] = reaction;
                }
                await updateDoc(postRef, { reactions: reactions });
            }
        }

        const shareButton = e.target.closest('.share-button');
        if (shareButton) {
            const postContent = shareButton.dataset.postContent;
            if (navigator.share) {
                navigator.share({ title: 'Check out this post!', text: postContent, url: window.location.href });
            } else {
                navigator.clipboard.writeText(postContent || window.location.href).then(() => alert('Post content copied!'));
            }
        }
        
        const commentButton = e.target.closest('.comment-button');
        if (commentButton) {
            const postId = commentButton.dataset.postId;
            const commentsSection = document.getElementById(`comments-section-${postId}`);
            if (commentsSection) {
                const isHidden = commentsSection.classList.toggle('hidden');
                if (!isHidden) {
                    loadComments(postId, commentsSection);
                }
            }
        }

        const replyButton = e.target.closest('.reply-button');
        if(replyButton) {
            const commentId = replyButton.dataset.commentId;
            const container = document.getElementById(`reply-input-container-${commentId}`);
            if(container.innerHTML !== '') { // Toggle off
                container.innerHTML = '';
            } else { // Toggle on
                container.innerHTML = `
                    <div class="flex mt-2">
                        <input type="text" id="reply-input-${commentId}" class="w-full bg-gray-900 rounded-l-lg p-2 text-sm" placeholder="Write a reply...">
                        <button data-comment-id="${commentId}" data-post-id="${replyButton.dataset.postId}" class="post-reply-button bg-sky-500 hover:bg-sky-600 text-white px-4 rounded-r-lg text-sm">Reply</button>
                    </div>
                `;
            }
        }

        const postReplyButton = e.target.closest('.post-reply-button');
        if(postReplyButton) {
            await postReply(postReplyButton.dataset.postId, postReplyButton.dataset.commentId);
        }

        const hashtagLink = e.target.closest('.hashtag-link');
        if (hashtagLink) {
            e.preventDefault();
            const hashtag = hashtagLink.dataset.hashtag;
            showHashtagPage(hashtag);
        }

        const postOptionsBtn = e.target.closest('.post-options-btn');
        if(postOptionsBtn) {
            const menu = postOptionsBtn.nextElementSibling;
            menu.classList.toggle('hidden');
        }

        const pinPostBtn = e.target.closest('.pin-post-btn');
        if(pinPostBtn) {
            const postId = pinPostBtn.dataset.postId;
            const userRef = doc(db, 'users', auth.currentUser.uid);
            if (currentUserData.pinnedPost === postId) {
                await updateDoc(userRef, { pinnedPost: null });
            } else {
                await updateDoc(userRef, { pinnedPost: postId });
            }
        }

        const blockUserBtn = e.target.closest('.block-user-btn');
        if(blockUserBtn) {
            const userIdToBlock = blockUserBtn.dataset.uid;
            if (confirm('Are you sure you want to block this user?')) {
                await updateDoc(doc(db, 'users', auth.currentUser.uid), {
                    blockedUsers: arrayUnion(userIdToBlock)
                });
            }
        }
    }

    async function postComment(e) {
        const postId = e.target.dataset.postId;
        const input = document.getElementById(`comment-input-${postId}`);
        const text = input.value.trim();

        if (!text) return;

        try {
            const postRef = doc(db, 'posts', postId);
            const commentsCollectionRef = collection(postRef, 'comments');

            await addDoc(commentsCollectionRef, {
                text: text,
                authorId: auth.currentUser.uid,
                authorName: currentUserData.displayName,
                authorPhotoURL: currentUserData.photoURL,
                createdAt: firestoreServerTimestamp(),
                replyCount: 0
            });

            await updateDoc(postRef, { commentCount: increment(1) });
            input.value = '';
        } catch (error) {
            console.error("Error posting comment:", error);
        }
    }

    async function postReply(postId, commentId) {
        const input = document.getElementById(`reply-input-${commentId}`);
        const text = input.value.trim();
        if (!text) return;

        try {
            const commentRef = doc(db, 'posts', postId, 'comments', commentId);
            const repliesCollectionRef = collection(commentRef, 'replies');

            await addDoc(repliesCollectionRef, {
                text: text,
                authorId: auth.currentUser.uid,
                authorName: currentUserData.displayName,
                authorPhotoURL: currentUserData.photoURL,
                createdAt: firestoreServerTimestamp()
            });

            await updateDoc(commentRef, { replyCount: increment(1) });
            document.getElementById(`reply-input-container-${commentId}`).innerHTML = '';
        } catch (error) {
            console.error("Error posting reply:", error);
        }
    }

    function loadReplies(postId, commentId, container) {
        const q = query(collection(db, 'posts', postId, 'comments', commentId, 'replies'), orderBy('createdAt', 'asc'));
        onSnapshot(q, (snapshot) => {
            container.innerHTML = '';
            snapshot.forEach(doc => {
                const reply = doc.data();
                const replyEl = document.createElement('div');
                replyEl.className = 'flex items-start text-sm pt-2';
                const replyDate = reply.createdAt?.toDate?.() ? reply.createdAt.toDate().toLocaleDateString() : 'Just now';
                replyEl.innerHTML = `
                    <img src="${reply.authorPhotoURL}" class="w-8 h-8 rounded-full mr-2">
                    <div>
                        <p class="bg-gray-900 rounded-lg px-3 py-2">
                            <span class="font-semibold text-sky-400">${reply.authorName}</span>
                            <span class="text-gray-400 text-xs ml-2">&middot; ${replyDate}</span>
                            <br>
                            ${reply.text}
                        </p>
                    </div>
                `;
                container.appendChild(replyEl);
            });
        });
    }

    async function loadComments(postId, container) {
        container.innerHTML = `
            <div class="flex mt-2">
                <input type="text" id="comment-input-${postId}" class="w-full bg-gray-700 rounded-l-lg p-2 text-sm" placeholder="Write a comment...">
                <button id="comment-submit-${postId}" data-post-id="${postId}" class="bg-sky-500 hover:bg-sky-600 text-white px-4 rounded-r-lg text-sm">Post</button>
            </div>
            <div id="comments-list-${postId}" class="mt-2 space-y-2"></div>
            <p class="text-gray-400 text-sm mt-2" id="comments-loading-${postId}">Loading comments...</p>
        `;

        const commentSubmitBtn = document.getElementById(`comment-submit-${postId}`);
        commentSubmitBtn.addEventListener('click', postComment);

        const commentsList = document.getElementById(`comments-list-${postId}`);
        const commentsLoading = document.getElementById(`comments-loading-${postId}`);

        const q = query(collection(db, 'posts', postId, 'comments'), orderBy('createdAt', 'desc'));
        onSnapshot(q, (snapshot) => {
            commentsList.innerHTML = '';
            if (snapshot.empty) {
                commentsLoading.textContent = 'No comments yet.';
            } else {
                commentsLoading.classList.add('hidden');
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const commentId = doc.id;
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment-container';
                    const commentDate = comment.createdAt?.toDate?.() ? comment.createdAt.toDate().toLocaleDateString() : 'Just now';
                    commentEl.innerHTML = `
                        <div class="flex items-start text-sm pt-2">
                            <img src="${comment.authorPhotoURL}" class="w-8 h-8 rounded-full mr-2">
                            <div>
                                <p class="bg-gray-700 rounded-lg px-3 py-2">
                                    <span class="font-semibold text-sky-400">${comment.authorName}</span>
                                    <span class="text-gray-400 text-xs ml-2">&middot; ${commentDate}</span>
                                    <br>
                                    ${comment.text}
                                </p>
                                <div class="pl-2 pt-1">
                                    <button class="reply-button text-xs font-semibold text-gray-400 hover:text-sky-400" data-post-id="${postId}" data-comment-id="${commentId}">Reply</button>
                                </div>
                            </div>
                        </div>
                        <div class="ml-10">
                            <div id="reply-input-container-${commentId}"></div>
                            <div id="replies-list-${commentId}" class="space-y-2"></div>
                        </div>
                    `;
                    commentsList.appendChild(commentEl);

                    if(comment.replyCount > 0) {
                        loadReplies(postId, commentId, document.getElementById(`replies-list-${commentId}`));
                    }
                });
            }
        });
    }

    function showHashtagPage(hashtag) {
        window.showPage('hashtag');
        const container = document.getElementById('hashtag-page-container');
        container.innerHTML = `<div class="card"><h2 class="text-2xl font-bold mb-4">#${hashtag}</h2><div id="hashtag-posts-container">Loading...</div></div>`;

        const postsContainer = document.getElementById('hashtag-posts-container');
        const q = query(collection(db, "posts"), where("hashtags", "array-contains", hashtag), orderBy("createdAt", "desc"));

        onSnapshot(q, (snapshot) => {
            postsContainer.innerHTML = '';
            if (snapshot.empty) {
                postsContainer.innerHTML = `<p class="text-gray-400">No posts found for this hashtag.</p>`;
                return;
            }
            snapshot.forEach(postDoc => {
                postsContainer.appendChild(renderPostElement(postDoc.id, postDoc.data()));
            });
        });
    }

    function renderGroupsPage() {
        const container = document.getElementById('groups-page-container');
        container.innerHTML = `
            <div id="groups-list-container">
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Groups</h2>
                        <button id="create-group-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Create Group</button>
                    </div>
                    <div id="groups-list"></div>
                </div>
            </div>
            <div id="single-group-container" class="hidden"></div>
        `;

        document.getElementById('create-group-btn').onclick = () => {
            document.getElementById('create-group-modal').classList.remove('hidden');
        };

        const groupsList = document.getElementById('groups-list');
        const q = query(collection(db, "groups"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            groupsList.innerHTML = '';
            if(snapshot.empty) {
                groupsList.innerHTML = `<p class="text-gray-400">No groups yet. Why not create one?</p>`;
                return;
            }
            snapshot.forEach(doc => {
                const group = doc.data();
                const groupId = doc.id;
                const groupEl = document.createElement('div');
                groupEl.className = 'p-4 bg-gray-800 rounded-lg mb-2 cursor-pointer hover:bg-gray-700';
                groupEl.innerHTML = `
                    <h3 class="font-semibold text-lg">${group.name}</h3>
                    <p class="text-gray-400 text-sm">${group.description}</p>
                `;
                groupEl.addEventListener('click', () => showGroupPage(groupId));
                groupsList.appendChild(groupEl);
            });
        });
    }

    async function showGroupPage(groupId) {
        document.getElementById('groups-list-container').classList.add('hidden');
        const container = document.getElementById('single-group-container');
        container.classList.remove('hidden');
        container.innerHTML = '<p class="text-gray-400">Loading group...</p>';

        const groupRef = doc(db, 'groups', groupId);
        const groupSnap = await getDoc(groupRef);

        if (!groupSnap.exists()) {
            container.innerHTML = '<p class="text-red-400">Group not found.</p>';
            return;
        }
        const groupData = groupSnap.data();

        container.innerHTML = `
            <div class="card">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">${groupData.name}</h2>
                        <p class="text-gray-400">${groupData.description}</p>
                    </div>
                    <div>
                        <button id="back-to-groups-list" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
                        <button id="invite-to-group-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg ml-2">Invite</button>
                    </div>
                </div>
            </div>
            <div class="card mt-4">
                <h2 class="text-xl font-semibold mb-4">Create a Post in ${groupData.name}</h2>
                <textarea id="group-post-content" class="w-full bg-gray-800 rounded-lg p-2" placeholder="What's on your mind?"></textarea>
                <div class="flex justify-end items-center mt-4">
                    <button id="create-group-post-button" data-group-id="${groupId}" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Post</button>
                </div>
            </div>
            <div class="card mt-4">
                <h2 class="text-xl font-semibold mb-4">Group Feed</h2>
                <div id="group-feed-container"></div>
            </div>
        `;

        document.getElementById('back-to-groups-list').addEventListener('click', () => {
            container.classList.add('hidden');
            document.getElementById('groups-list-container').classList.remove('hidden');
        });
        
        // TODO: Invite button logic
        
        document.getElementById('create-group-post-button').addEventListener('click', async () => {
            const content = document.getElementById('group-post-content').value.trim();
            if (!content) return;

            try {
                await addDoc(collection(db, 'posts'), {
                    authorId: auth.currentUser.uid,
                    authorName: currentUserData.displayName,
                    authorPhotoURL: currentUserData.photoURL,
                    content: content,
                    groupId: groupId, // Link post to the group
                    createdAt: firestoreServerTimestamp(),
                    reactions: {},
                    commentCount: 0,
                    visibility: ['group'] // Special visibility for group posts
                });
                document.getElementById('group-post-content').value = '';
            } catch (error) {
                console.error("Error creating group post:", error);
            }
        });

        const feedContainer = document.getElementById('group-feed-container');
        const q = query(collection(db, "posts"), where("groupId", "==", groupId), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            feedContainer.innerHTML = '';
            if (snapshot.empty) {
                feedContainer.innerHTML = '<p class="text-gray-400">No posts in this group yet. Be the first!</p>';
                return;
            }
            snapshot.forEach(postDoc => {
                feedContainer.appendChild(renderPostElement(postDoc.id, postDoc.data()));
            });
        });
    }

    function setupGroups() {
        const modal = document.getElementById('create-group-modal');
        const closeBtn = document.getElementById('close-create-group-modal');
        const form = document.getElementById('create-group-form');

        closeBtn.onclick = () => modal.classList.add('hidden');

        form.onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('group-name-input').value;
            const description = document.getElementById('group-description-input').value;

            if(!name) return;

            try {
                await addDoc(collection(db, 'groups'), {
                    name: name,
                    description: description,
                    createdAt: firestoreServerTimestamp(),
                    ownerId: auth.currentUser.uid,
                    members: [auth.currentUser.uid]
                });
                modal.classList.add('hidden');
                form.reset();
            } catch (error) {
                document.getElementById('create-group-error').textContent = error.message;
            }
        };
    }

    function setupUserMenu() {
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        const signOutButton = document.getElementById('sign-out-button');

        userMenuButton.addEventListener('click', () => {
            userMenuDropdown.classList.toggle('hidden');
        });

        signOutButton.addEventListener('click', (e) => {
            e.preventDefault();
            if (chatUnsubscribe) chatUnsubscribe();
            signOut(auth);
        });

        document.addEventListener('click', (e) => {
            if (!userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                userMenuDropdown.classList.add('hidden');
            }
        });
    }

    function setupProfilePictureEditing() {
        const modal = document.getElementById('profile-pic-modal');
        const closeBtn = document.getElementById('close-pic-modal');
        const selectImageBtn = document.getElementById('select-image-btn');
        const uploadInput = document.getElementById('profile-pic-upload-input');
        const editorDiv = document.getElementById('profile-pic-editor');
        const cropImage = document.getElementById('profile-pic-crop-image');
        const saveBtn = document.getElementById('save-profile-pic-btn');
        const loadingDiv = document.getElementById('pic-upload-loading');
        let cropper = null;

        closeBtn.onclick = () => {
            modal.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            editorDiv.classList.add('hidden');
            uploadInput.value = ''; // Reset file input
        };

        selectImageBtn.onclick = () => uploadInput.click();

        uploadInput.onchange = (e) => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    cropImage.src = event.target.result;
                    editorDiv.classList.remove('hidden');
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(cropImage, {
                        aspectRatio: 1,
                        viewMode: 1,
                        background: false,
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        saveBtn.onclick = async () => {
            if (!cropper) return;

            loadingDiv.classList.remove('hidden');
            saveBtn.disabled = true;

            cropper.getCroppedCanvas({
                width: 512,
                height: 512,
            }).toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                    const data = await res.json();
                    const newPhotoURL = data.secure_url;

                    await updateDoc(doc(db, 'users', auth.currentUser.uid), { photoURL: newPhotoURL });
                    await updateProfile(auth.currentUser, { photoURL: newPhotoURL });

                    loadingDiv.classList.add('hidden');
                    saveBtn.disabled = false;
                    closeBtn.onclick();
                } catch (err) {
                    console.error("Error uploading profile picture:", err);
                    loadingDiv.classList.add('hidden');
                    saveBtn.disabled = false;
                    alert('Upload failed. Please try again.');
                }
            }, 'image/jpeg');
        };
    }

    function setupCoverPhotoEditing() {
        const modal = document.getElementById('cover-photo-modal');
        const closeBtn = document.getElementById('close-cover-modal');
        const selectImageBtn = document.getElementById('select-cover-image-btn');
        const uploadInput = document.getElementById('cover-photo-upload-input');
        const editorDiv = document.getElementById('cover-photo-editor');
        const cropImage = document.getElementById('cover-photo-crop-image');
        const saveBtn = document.getElementById('save-cover-photo-btn');
        const loadingDiv = document.getElementById('cover-upload-loading');
        let cropper = null;

        closeBtn.onclick = () => {
            modal.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            editorDiv.classList.add('hidden');
            uploadInput.value = '';
        };

        selectImageBtn.onclick = () => uploadInput.click();

        uploadInput.onchange = (e) => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    cropImage.src = event.target.result;
                    editorDiv.classList.remove('hidden');
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(cropImage, {
                        aspectRatio: 16 / 6,
                        viewMode: 2,
                        background: false,
                        autoCropArea: 1
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        };

        saveBtn.onclick = async () => {
            if (!cropper) return;

            loadingDiv.classList.remove('hidden');
            saveBtn.disabled = true;

            cropper.getCroppedCanvas({
                width: 1200,
                height: 450,
            }).toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                try {
                    const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                    const data = await res.json();
                    const newCoverURL = data.secure_url;

                    await updateDoc(doc(db, 'users', auth.currentUser.uid), { coverPhotoURL: newCoverURL });

                    loadingDiv.classList.add('hidden');
                    saveBtn.disabled = false;
                    closeBtn.onclick();
                } catch (err) {
                    console.error("Error uploading cover photo:", err);
                    loadingDiv.classList.add('hidden');
                    saveBtn.disabled = false;
                    alert('Upload failed. Please try again.');
                }
            }, 'image/jpeg');
        };
    }

    function setupFeelingModal() {
        const feelingButton = document.getElementById('feeling-button');
        const modal = document.getElementById('feeling-modal');
        const closeBtn = document.getElementById('close-feeling-modal');
        const emojiGrid = document.getElementById('emoji-grid');
        const saveBtn = document.getElementById('save-feeling-btn');
        const activityInput = document.getElementById('activity-input');
        const feelingDisplay = document.getElementById('feeling-display');

        const emojis = ['😄', '🥰', '🥳', '🤩', '🤔', '😢', '😠', '🤯', '😴', '🎉', '✈️', '🍕', '🎮', '🎬', '🎵', '📖'];
        let selectedEmoji = null;

        emojiGrid.innerHTML = emojis.map(emoji => `<div class="p-2 rounded-full hover:bg-sky-500 transition-colors">${emoji}</div>`).join('');

        feelingButton.onclick = () => modal.classList.remove('hidden');
        closeBtn.onclick = () => modal.classList.add('hidden');

        emojiGrid.addEventListener('click', (e) => {
            if (e.target.tagName === 'DIV') {
                // Clear previous selection
                Array.from(emojiGrid.children).forEach(child => child.classList.remove('bg-sky-500'));
                // Select new one
                e.target.classList.add('bg-sky-500');
                selectedEmoji = e.target.textContent;
            }
        });

        saveBtn.onclick = () => {
            const activityText = activityInput.value.trim();
            if (!selectedEmoji || !activityText) {
                alert('Please select an emoji and enter an activity.');
                return;
            }

            currentFeeling = { emoji: selectedEmoji, text: activityText };
            
            feelingDisplay.innerHTML = `
                <span>— is feeling ${currentFeeling.emoji} ${currentFeeling.text}</span>
                <button id="remove-feeling" class="ml-2 text-red-500 font-bold">&times;</button>
            `;
            feelingDisplay.classList.remove('hidden');
            feelingDisplay.classList.add('flex');

            modal.classList.add('hidden');
        };

        feelingDisplay.addEventListener('click', (e) => {
            if (e.target.id === 'remove-feeling') {
                currentFeeling = null;
                feelingDisplay.classList.add('hidden');
                feelingDisplay.innerHTML = '';
            }
        });
    }

    function setupStories() {
        const storiesContainer = document.getElementById('stories-container');
        if (storyUnsubscribe) storyUnsubscribe();

        const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        const q = query(collection(db, "stories"), where('createdAt', '>', twentyFourHoursAgo), orderBy('createdAt', 'desc'));

        storyUnsubscribe = onSnapshot(q, (snapshot) => {
            storiesCache = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            renderStoriesBar();
        });

        storiesContainer.addEventListener('click', (e) => {
            const storyAuthorId = e.target.closest('.story-circle')?.dataset.authorId;
            if (storyAuthorId) {
                openStoryViewer(storyAuthorId);
            }

            const createStoryBtn = e.target.closest('#create-story-btn');
            if(createStoryBtn) {
                document.getElementById('create-story-modal').classList.remove('hidden');
                document.getElementById('story-upload-input').click();
            }
        });

        setupStoryCreation();
    }

    function setupStoryCreation() {
        const modal = document.getElementById('create-story-modal');
        const closeBtn = document.getElementById('close-create-story-modal');
        const uploadInput = document.getElementById('story-upload-input');
        const previewContainer = document.getElementById('story-upload-preview');
        const errorDiv = document.getElementById('story-upload-error');
        const postBtn = document.getElementById('post-story-btn');
        let uploadedStoryMedia = null;

        closeBtn.onclick = () => {
            modal.classList.add('hidden');
            previewContainer.innerHTML = '';
            errorDiv.textContent = '';
            postBtn.classList.add('hidden');
            uploadedStoryMedia = null;
        };

        uploadInput.onchange = async (e) => {
            if (!e.target.files[0]) return;
            const file = e.target.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            previewContainer.innerHTML = `<p class="text-gray-400">Uploading...</p>`;
            postBtn.classList.add('hidden');

            try {
                const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                const data = await res.json();
                uploadedStoryMedia = { url: data.secure_url, type: data.resource_type };
                previewContainer.innerHTML = data.resource_type.startsWith('video')
                    ? `<video src="${uploadedStoryMedia.url}" class="rounded-lg max-h-full mx-auto" controls></video>`
                    : `<img src="${uploadedStoryMedia.url}" class="rounded-lg max-h-full mx-auto">`;
                postBtn.classList.remove('hidden');
                errorDiv.textContent = '';
            } catch (err) {
                previewContainer.innerHTML = '';
                errorDiv.textContent = 'Upload failed. Please try again.';
                uploadedStoryMedia = null;
            }
        };

        postBtn.onclick = async () => {
            if (!uploadedStoryMedia) return;

            try {
                await addDoc(collection(db, 'stories'), {
                    authorId: auth.currentUser.uid,
                    authorName: currentUserData.displayName,
                    authorPhotoURL: currentUserData.photoURL,
                    mediaUrl: uploadedStoryMedia.url,
                    mediaType: uploadedStoryMedia.type,
                    createdAt: firestoreServerTimestamp(),
                });
                closeBtn.onclick();
            } catch (error) {
                console.error("Error creating story:", error);
                errorDiv.textContent = 'Failed to post story.';
            }
        };
    }

    function renderStoriesBar() {
        const storiesContainer = document.getElementById('stories-container');
        const storiesByAuthor = storiesCache.reduce((acc, story) => {
            if (!acc[story.authorId]) {
                acc[story.authorId] = {
                    authorName: story.authorName,
                    authorPhotoURL: story.authorPhotoURL,
                    stories: []
                };
            }
            acc[story.authorId].stories.push(story);
            return acc;
        }, {});

        let storiesHTML = '<div class="flex space-x-4 overflow-x-auto p-2">'

        // Add Your Story button
        storiesHTML += `
            <div id="create-story-btn" class="text-center flex-shrink-0">
                <div class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center cursor-pointer border-2 border-dashed border-gray-500 hover:border-sky-400">
                    <i class="fas fa-plus text-2xl text-gray-400"></i>
                </div>
                <p class="text-xs mt-1">Your Story</p>
            </div>
        `;

        for (const authorId in storiesByAuthor) {
            const authorData = storiesByAuthor[authorId];
            storiesHTML += `
                <div class="text-center flex-shrink-0 story-circle" data-author-id="${authorId}">
                    <div class="w-16 h-16 rounded-full p-1 bg-gradient-to-tr from-yellow-400 to-fuchsia-600 cursor-pointer">
                        <img src="${authorData.authorPhotoURL}" class="w-full h-full rounded-full object-cover border-2 border-gray-900">
                    </div>
                    <p class="text-xs mt-1 truncate w-16">${authorData.authorName}</p>
                </div>
            `;
        }

        storiesHTML += '</div>';
        storiesContainer.innerHTML = storiesHTML;
    }

    function openStoryViewer(authorId) {
        const modal = document.getElementById('story-viewer-modal');
        const content = document.getElementById('story-content');
        const closeBtn = document.getElementById('close-story-viewer');
        const nextBtn = document.getElementById('story-next');
        const prevBtn = document.getElementById('story-prev');

        const authorStories = storiesCache.filter(s => s.authorId === authorId);
        let currentIndex = 0;
        let storyTimeout;

        function showStory(index) {
            clearTimeout(storyTimeout);
            const story = authorStories[index];
            let mediaHTML = '';
            if (story.mediaType.startsWith('image')) {
                mediaHTML = `<img src="${story.mediaUrl}" class="max-h-full max-w-full object-contain">`;
                storyTimeout = setTimeout(nextStory, 7000);
            } else {
                mediaHTML = `<video id="story-video-player" src="${story.mediaUrl}" class="max-h-full max-w-full object-contain" autoplay muted></video>`;
            }

            content.innerHTML = `
                <div class="absolute top-0 left-0 right-0 p-4 flex items-center bg-gradient-to-b from-black/50 to-transparent">
                    <img src="${story.authorPhotoURL}" class="w-10 h-10 rounded-full mr-2">
                    <span class="font-semibold text-white">${story.authorName}</span>
                </div>
                ${mediaHTML}
            `;

            if (story.mediaType.startsWith('video')) {
                const videoPlayer = document.getElementById('story-video-player');
                videoPlayer.onended = nextStory;
            }
        }

        function nextStory() {
            if (currentIndex < authorStories.length - 1) {
                currentIndex++;
                showStory(currentIndex);
            } else {
                modal.classList.add('hidden');
            }
        }

        showStory(currentIndex);

        nextBtn.onclick = () => {
            if (currentIndex < authorStories.length - 1) {
                currentIndex++;
                showStory(currentIndex);
            }
        };

        prevBtn.onclick = () => {
            if (currentIndex > 0) {
                currentIndex--;
                showStory(currentIndex);
            }
        };

        closeBtn.onclick = () => {
            clearTimeout(storyTimeout);
            modal.classList.add('hidden');
        };

        modal.classList.remove('hidden');
    }

</script>
</body>
</html>