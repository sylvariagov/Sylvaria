<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/179ab4bc4c.js" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #111827; color: #f3f4f6; }
        .card { background-color: #1f2937; border-radius: 1.5rem; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.25); }
        .like-button.liked, .nav-button.active { color: #38bdf8; }
        #feeling-modal .emoji-button:hover { transform: scale(1.2); transition: transform 0.1s; }
    </style>
</head>
<body class="bg-gray-900">

    <header class="bg-gray-800 shadow-lg p-4 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center space-x-4">
            <a href="launchpad.html" class="text-gray-300 hover:text-white text-sm font-semibold"><i class="fas fa-rocket mr-2"></i>Launchpad</a>
            <h1 class="text-2xl font-bold text-sky-400 ml-4">Connect</h1>
        </div>
        <div id="header-nav" class="hidden items-center space-x-4">
            <a href="#" id="home-button" class="nav-button text-gray-300 hover:text-white active"><i class="fas fa-home"></i></a>
            <a href="#" id="friends-button" class="nav-button text-gray-300 hover:text-white"><i class="fas fa-user-friends"></i></a>
            <a href="#" id="notifications-button" class="nav-button text-gray-300 hover:text-white relative"><i class="fas fa-bell"></i><span id="friend-request-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center"></span></a>
            <div id="user-menu" class="relative">
                <button id="user-menu-button" class="text-gray-300 hover:text-white"><i class="fas fa-user-circle text-2xl"></i></button>
                <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1 ring-1 ring-black ring-opacity-5">
                    <a href="#" id="sign-out-button" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Sign Out</a>
                </div>
            </div>
        </div>
    </header>

    <main class="p-4 hidden" id="main-content">
         <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="md:col-span-1">
                <div class="sticky top-20">
                    <div class="card text-center" id="profile-card"></div>
                    <div class="card mt-4">
                        <h2 class="text-xl font-semibold mb-4">Online</h2>
                        <div id="online-users-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>
            <div class="md:col-span-2">
                <!-- Main Content Area: Feed, Friends, Notifications -->
                <div id="feed-page-container"></div>
                <div id="friends-page-container" class="hidden"></div>
                <div id="notifications-page-container" class="hidden"></div>
            </div>
            <div class="md:col-span-1"></div>
        </div>
    </main>
    
    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 z-50 text-center p-4">
        <p class="text-gray-400 text-lg">Authenticating...</p>
    </div>

    <!-- Modals -->
    <div id="feeling-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50"></div>
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50"></div>

    <!-- Firebase and Auth Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, serverTimestamp as firestoreServerTimestamp, query, where, orderBy, onSnapshot, updateDoc, increment, runTransaction, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore.js";
        import { getDatabase, ref, onValue, onDisconnect, set, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2NK-z6i74kTExGUE_ilN1jM8_oqEeSRs",
            authDomain: "sylvaria-universe.firebaseapp.com",
            projectId: "sylvaria-universe",
            storageBucket: "sylvaria-universe.firebasestorage.app",
            messagingSenderId: "256537971475",
            appId: "1:256537971475:web:baaac36786b918338428e6",
            measurementId: "G-4MCYL3VM15",
            databaseURL: "https://sylvaria-universe-default-rtdb.firebaseio.com",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);

        const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/djkz4hbed/upload';
        const CLOUDINARY_UPLOAD_PRESET = 'zaybn6xt';

        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
            const data = await response.json();
            if (data.secure_url) {
                return { url: data.secure_url, type: data.resource_type };
            } else {
                throw new Error('Cloudinary upload failed');
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const userRef = doc(db, "users", user.uid);

                let userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    const newUserProfile = { displayName: user.displayName || (user.email ? user.email.split('@')[0] : 'New User'), email: user.email || 'No email provided', photoURL: user.photoURL || `https://api.dicebear.com/7.x/initials/svg?seed=${user.uid}`, createdAt: new Date().toISOString(), friends: [], friendRequestsSent: [], friendRequestsReceived: [], posts: 0 };
                    await setDoc(userRef, newUserProfile);
                    userSnap = await getDoc(userRef);
                }
                
                document.getElementById('feed-page-container').innerHTML = `<div class="card"><h2 class="text-xl font-semibold mb-4">Create a Post</h2><textarea id="post-content" class="w-full bg-gray-800 rounded-lg p-2" placeholder="What's on your mind?"></textarea><div id="media-preview-container" class="mt-4"></div><input type="file" id="media-upload-input" class="hidden" accept="image/*,video/*"><div class="flex justify-between items-center mt-4"><div class="flex space-x-4"><button id="photo-button" class="text-gray-400 hover:text-sky-400"><i class="fas fa-image mr-2"></i>Photo/Video</button><button id="feeling-button" class="text-gray-400 hover:text-sky-400"><i class="fas fa-smile mr-2"></i>Feeling/Activity</button></div><button id="create-post-button" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Post</button></div></div><div class="card mt-4"><h2 class="text-xl font-semibold mb-4">Feed</h2><div id="feed-container"></div></div>`;
                document.getElementById('friends-page-container').innerHTML = `<div class="card"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Find People</h2><div class="relative"><input type="search" id="user-search-input" placeholder="Search..." class="bg-gray-800 rounded-lg p-2 pl-8 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-sky-500"><i class="fas fa-search absolute left-2.5 top-2.5 text-gray-500"></i></div></div><div id="all-users-container" class="space-y-4"></div></div>`;
                document.getElementById('notifications-page-container').innerHTML = `<div class="card"><h2 class="text-xl font-semibold mb-4">Friend Requests</h2><div id="friend-requests-container" class="space-y-4"></div></div>`;
                document.getElementById('feeling-modal').innerHTML = `<div class="card w-full max-w-md"><h2 class="text-xl font-semibold mb-4">How are you feeling?</h2><div id="emoji-grid" class="grid grid-cols-6 gap-4 text-3xl cursor-pointer"></div></div>`;
                document.getElementById('edit-profile-modal').innerHTML = `<div class="card w-full max-w-md"><h2 class="text-xl font-semibold mb-4">Edit Profile</h2><div class="space-y-4"><div class="flex items-center space-x-4"><img id="edit-pfp-preview" class="w-24 h-24 rounded-full object-cover"><label for="pfp-upload-input" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer">Upload New Picture</label><input type="file" id="pfp-upload-input" class="hidden" accept="image/*"></div><div><label for="edit-name-input" class="block text-sm font-medium text-gray-400">Display Name</label><input type="text" id="edit-name-input" class="w-full bg-gray-800 rounded-lg p-2 mt-1"></div></div><div class="flex justify-end space-x-4 mt-6"><button id="cancel-edit-profile" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button id="save-edit-profile" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Save</button></div></div>`;

                onSnapshot(userRef, (doc) => {
                    const userData = doc.data();
                    if (!userData) return;
                    const profileCard = document.getElementById('profile-card');
                    profileCard.innerHTML = `<div class="relative"><img src="${userData.photoURL}" alt="Profile Picture" class="w-24 h-24 rounded-full mx-auto object-cover"><button id="edit-profile-button" class="absolute bottom-0 right-10 bg-gray-800 p-2 rounded-full text-white hover:bg-gray-700"><i class="fas fa-pencil-alt"></i></button></div><h2 class="text-xl font-semibold mt-4">${userData.displayName}</h2><p class="text-gray-400">${userData.email}</p><div class="flex justify-around mt-4 border-t border-gray-700 pt-4"><div><p class="font-bold text-lg">${userData.posts || 0}</p><p class="text-gray-400 text-sm">Posts</p></div><div><p class="font-bold text-lg">${(userData.friends || []).length}</p><p class="text-gray-400 text-sm">Friends</p></div></div>`;
                    document.getElementById('edit-profile-button').addEventListener('click', () => {
                        document.getElementById('edit-name-input').value = userData.displayName;
                        document.getElementById('edit-pfp-preview').src = userData.photoURL;
                        document.getElementById('edit-profile-modal').classList.remove('hidden');
                    });
                    const badge = document.getElementById('friend-request-badge');
                    const requestCount = (userData.friendRequestsReceived || []).length;
                    if (requestCount > 0) { badge.textContent = requestCount; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
                });

                const userStatusDatabaseRef = ref(rtdb, '/status/' + user.uid);
                const isOfflineForDatabase = { state: 'offline', last_changed: rtdbServerTimestamp() };
                const isOnlineForDatabase = { state: 'online', last_changed: rtdbServerTimestamp(), displayName: userSnap.data().displayName, photoURL: userSnap.data().photoURL };
                onValue(ref(rtdb, '.info/connected'), (snapshot) => {
                    if (snapshot.val() === false) { return; };
                    onDisconnect(userStatusDatabaseRef).set(isOfflineForDatabase).then(() => set(userStatusDatabaseRef, isOnlineForDatabase));
                });

                const onlineUsersContainer = document.getElementById('online-users-container');
                onValue(ref(rtdb, 'status'), (snapshot) => {
                    onlineUsersContainer.innerHTML = '';
                    let onlineCount = 0;
                    snapshot.forEach((childSnapshot) => {
                        const status = childSnapshot.val();
                        if (status.state === 'online') {
                            onlineCount++;
                            const userElement = document.createElement('div');
                            userElement.className = 'flex items-center';
                            userElement.innerHTML = `<div class="relative"><div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center overflow-hidden"><img src="${status.photoURL}" alt="${status.displayName}" class="w-full h-full object-cover"></div><span class="absolute bottom-0 right-0 block h-3 w-3 rounded-full ring-2 ring-gray-900 bg-green-500"></span></div><p class="ml-3 font-semibold">${status.displayName}</p>`;
                            onlineUsersContainer.appendChild(userElement);
                        }
                    });
                    if (onlineCount === 0) { onlineUsersContainer.innerHTML = `<p class="text-gray-400">No users are currently online.</p>`; }
                });

                const feedPage = document.getElementById('feed-page-container');
                const friendsPage = document.getElementById('friends-page-container');
                const notificationsPage = document.getElementById('notifications-page-container');
                const navButtons = { home: document.getElementById('home-button'), friends: document.getElementById('friends-button'), notifications: document.getElementById('notifications-button') };
                function showPage(page) {
                    feedPage.classList.add('hidden');
                    friendsPage.classList.add('hidden');
                    notificationsPage.classList.add('hidden');
                    Object.values(navButtons).forEach(b => b.classList.remove('active'));
                    if (page === 'feed') { feedPage.classList.remove('hidden'); navButtons.home.classList.add('active'); }
                    if (page === 'friends') { friendsPage.classList.remove('hidden'); navButtons.friends.classList.add('active'); }
                    if (page === 'notifications') { notificationsPage.classList.remove('hidden'); navButtons.notifications.classList.add('active'); }
                }
                navButtons.home.addEventListener('click', (e) => { e.preventDefault(); showPage('feed'); });
                navButtons.notifications.addEventListener('click', (e) => { e.preventDefault(); showPage('notifications'); displayFriendRequests(); });

                const allUsersContainer = document.getElementById('all-users-container');
                const friendRequestsContainer = document.getElementById('friend-requests-container');
                let allUsersCache = [];

                async function sendFriendRequest(recipientId) {
                    const recipientRef = doc(db, "users", recipientId);
                    await updateDoc(userRef, { friendRequestsSent: arrayUnion(recipientId) });
                    await updateDoc(recipientRef, { friendRequestsReceived: arrayUnion(user.uid) });
                }
                async function acceptFriendRequest(senderId) {
                    const senderRef = doc(db, "users", senderId);
                    await updateDoc(userRef, { friends: arrayUnion(senderId), friendRequestsReceived: arrayRemove(senderId) });
                    await updateDoc(senderRef, { friends: arrayUnion(user.uid), friendRequestsSent: arrayRemove(user.uid) });
                }
                async function declineFriendRequest(senderId) {
                    const senderRef = doc(db, "users", senderId);
                    await updateDoc(userRef, { friendRequestsReceived: arrayRemove(senderId) });
                    await updateDoc(senderRef, { friendRequestsSent: arrayRemove(user.uid) });
                }

                async function fetchAllUsers() {
                    allUsersCache = [];
                    const usersCollection = collection(db, "users");
                    const querySnapshot = await getDocs(usersCollection);
                    querySnapshot.forEach((doc) => {
                        if (doc.id !== user.uid) {
                            allUsersCache.push({ id: doc.id, ...doc.data() });
                        }
                    });
                }

                function renderAllUsers(searchTerm = '') {
                    allUsersContainer.innerHTML = '';
                    const currentUserData = userSnap.data();
                    const filteredUsers = allUsersCache.filter(u => u.displayName.toLowerCase().includes(searchTerm.toLowerCase()));
                    if (filteredUsers.length === 0) { allUsersContainer.innerHTML = `<p class="text-gray-400">No users found.</p>`; return; }
                    filteredUsers.forEach((otherUser) => {
                        const userElement = document.createElement('div');
                        userElement.className = 'flex items-center justify-between';
                        let buttonHtml;
                        if (currentUserData.friends?.includes(otherUser.id)) { buttonHtml = `<button disabled class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">Friends</button>`;
                        } else if (currentUserData.friendRequestsSent?.includes(otherUser.id)) { buttonHtml = `<button disabled class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">Request Sent</button>`;
                        } else if (currentUserData.friendRequestsReceived?.includes(otherUser.id)) { buttonHtml = `<button data-uid="${otherUser.id}" class="accept-friend-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Accept</button>`;
                        } else { buttonHtml = `<button data-uid="${otherUser.id}" class="add-friend-button bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Add Friend</button>`; }
                        userElement.innerHTML = `<div class="flex items-center"><div class="w-12 h-12 rounded-full bg-gray-700 flex-shrink-0 overflow-hidden"><img src="${otherUser.photoURL}" class="w-full h-full object-cover"></div><p class="ml-4 font-semibold">${otherUser.displayName}</p></div>${buttonHtml}`;
                        allUsersContainer.appendChild(userElement);
                    });
                }
                document.getElementById('user-search-input').addEventListener('input', (e) => renderAllUsers(e.target.value));
                navButtons.friends.addEventListener('click', async (e) => { e.preventDefault(); showPage('friends'); await fetchAllUsers(); renderAllUsers(); });

                async function displayFriendRequests() {
                    friendRequestsContainer.innerHTML = '';
                    const received = userSnap.data().friendRequestsReceived || [];
                    if (received.length === 0) { friendRequestsContainer.innerHTML = `<p class="text-gray-400">No new friend requests.</p>`; return; }
                    for (const senderId of received) {
                        const senderSnap = await getDoc(doc(db, "users", senderId));
                        if (senderSnap.exists()) {
                            const senderData = senderSnap.data();
                            const requestElement = document.createElement('div');
                            requestElement.className = 'flex items-center justify-between';
                            requestElement.innerHTML = `<div class="flex items-center"><div class="w-12 h-12 rounded-full bg-gray-700 flex-shrink-0 overflow-hidden"><img src="${senderData.photoURL}" class="w-full h-full object-cover"></div><p class="ml-4 font-semibold">${senderData.displayName}</p></div><div><button data-uid="${senderId}" class="accept-friend-button bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Accept</button><button data-uid="${senderId}" class="decline-friend-button bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg ml-2">Decline</button></div>`;
                            friendRequestsContainer.appendChild(requestElement);
                        }
                    }
                }
                allUsersContainer.addEventListener('click', (e) => { 
                    if (e.target.classList.contains('add-friend-button')) { sendFriendRequest(e.target.dataset.uid); }
                    if (e.target.classList.contains('accept-friend-button')) { acceptFriendRequest(e.target.dataset.uid); }
                });
                friendRequestsContainer.addEventListener('click', (e) => {
                    const uid = e.target.dataset.uid;
                    if (e.target.classList.contains('accept-friend-button')) { acceptFriendRequest(uid); }
                    if (e.target.classList.contains('decline-friend-button')) { declineFriendRequest(uid); }
                });

                const mediaUploadInput = document.getElementById('media-upload-input');
                const mediaPreviewContainer = document.getElementById('media-preview-container');
                let uploadedMedia = null;
                document.getElementById('photo-button').addEventListener('click', () => mediaUploadInput.click());
                mediaUploadInput.addEventListener('change', async (e) => {
                    if (e.target.files && e.target.files[0]) {
                        mediaPreviewContainer.innerHTML = `<p class="text-gray-400">Uploading...</p>`;
                        try {
                            uploadedMedia = await uploadToCloudinary(e.target.files[0]);
                            if (uploadedMedia.type.startsWith('video')) {
                                mediaPreviewContainer.innerHTML = `<video src="${uploadedMedia.url}" class="rounded-lg max-h-40 mx-auto" controls></video>`;
                            } else {
                                mediaPreviewContainer.innerHTML = `<img src="${uploadedMedia.url}" class="rounded-lg max-h-40 mx-auto">`;
                            }
                        } catch (error) { mediaPreviewContainer.innerHTML = `<p class="text-red-400">Upload failed.</p>`; uploadedMedia = null; }
                    }
                });

                document.getElementById('create-post-button').addEventListener('click', async () => {
                    const content = document.getElementById('post-content').value.trim();
                    if (content || uploadedMedia) {
                        try {
                            await addDoc(collection(db, 'posts'), { authorId: user.uid, authorName: userSnap.data().displayName, authorPhotoURL: userSnap.data().photoURL, content: content, mediaUrl: uploadedMedia?.url, mediaType: uploadedMedia?.type, createdAt: firestoreServerTimestamp(), likes: 0, commentCount: 0 });
                            await updateDoc(userRef, { posts: increment(1) });
                            document.getElementById('post-content').value = ''; mediaPreviewContainer.innerHTML = ''; uploadedMedia = null;
                        } catch (error) { console.error("Error creating post:", error); }
                    }
                });

                const feedContainer = document.getElementById('feed-container');
                const postsQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));
                onSnapshot(postsQuery, (querySnapshot) => {
                    feedContainer.innerHTML = '';
                    if (querySnapshot.empty) { feedContainer.innerHTML = `<p class="text-gray-400">No posts yet.</p>`; return; }
                    querySnapshot.forEach(async (postDoc) => {
                        const post = postDoc.data();
                        const postDate = post.createdAt?.toDate().toLocaleString() || 'Just now';
                        const likeRef = doc(db, "posts", postDoc.id, "likes", user.uid);
                        const likeSnap = await getDoc(likeRef);
                        const isLiked = likeSnap.exists();
                        let mediaHTML = '';
                        if (post.mediaUrl) {
                            if (post.mediaType.startsWith('video')) {
                                mediaHTML = `<video src="${post.mediaUrl}" class="mt-4 rounded-lg w-full object-cover" controls></video>`;
                            } else {
                                mediaHTML = `<img src="${post.mediaUrl}" class="mt-4 rounded-lg max-h-96 w-full object-cover">`;
                            }
                        }
                        const postElement = document.createElement('div');
                        postElement.className = 'border-t border-gray-700 pt-4 mt-4';
                        postElement.innerHTML = `
                            <div class="flex items-start">
                                <div class="w-12 h-12 rounded-full bg-gray-700 flex-shrink-0 overflow-hidden"><img src="${post.authorPhotoURL}" alt="${post.authorName}" class="w-full h-full object-cover"></div>
                                <div class="ml-4 flex-grow">
                                    <div class="flex items-center"><h3 class="font-semibold">${post.authorName}</h3><span class="text-gray-400 text-sm ml-2">&middot; ${postDate}</span></div>
                                    <p class="mt-1">${post.content}</p>
                                    ${mediaHTML}
                                    <div class="mt-4 flex items-center text-gray-400">
                                        <button data-post-id="${postDoc.id}" class="like-button ${isLiked ? 'liked' : ''} hover:text-sky-400 flex items-center"><i class="fas fa-thumbs-up mr-2"></i><span class="like-count">${post.likes || 0}</span></button>
                                        <button data-post-id="${postDoc.id}" class="comment-button hover:text-sky-400 ml-4 flex items-center"><i class="fas fa-comment mr-2"></i><span class="comment-count">${post.commentCount || 0}</span></button>
                                        <button data-post-id="${postDoc.id}" data-post-content="${post.content || ''}" class="share-button hover:text-sky-400 ml-4 flex items-center"><i class="fas fa-share mr-2"></i>Share</button>
                                    </div>
                                    <div class="comments-section mt-4 space-y-4 hidden" id="comments-section-${postDoc.id}"></div>
                                </div>
                            </div>`;
                        feedContainer.appendChild(postElement);
                    });
                });

                async function likePost(postId) { /* ... */ }
                async function addComment(postId, commentText) { /* ... */ }
                function displayComments(postId, container) { /* ... */ }
                async function sharePost(button) { /* ... */ }

                feedContainer.addEventListener('click', (e) => {
                    const target = e.target;
                    const likeButton = target.closest('.like-button');
                    const commentButton = target.closest('.comment-button');
                    const shareButton = target.closest('.share-button');
                    if (likeButton) { likePost(likeButton.dataset.postId); }
                    if (commentButton) { 
                        const commentsSection = document.getElementById(`comments-section-${commentButton.dataset.postId}`);
                        commentsSection.classList.toggle('hidden');
                        if (!commentsSection.classList.contains('hidden')) { displayComments(commentButton.dataset.postId, commentsSection); }
                    }
                    if (shareButton) { sharePost(shareButton); }
                });
                feedContainer.addEventListener('submit', (e) => { /* ... */ });

                const feelingModal = document.getElementById('feeling-modal');
                const emojiGrid = document.getElementById('emoji-grid');
                const postContentInput = document.getElementById('post-content');
                const feelings = ['ðŸ˜Š', 'ðŸ˜‚', 'ðŸ˜', 'ðŸ¤”', 'ðŸ˜¢', 'ðŸ˜ ', 'ðŸ‘', 'ðŸŽ‰', 'ðŸ”¥', 'ðŸ’¯', 'â¤ï¸', 'ðŸ™'];
                emojiGrid.innerHTML = feelings.map(emoji => `<button class="emoji-button text-3xl hover:scale-125 transition-transform">${emoji}</button>`).join('');
                document.getElementById('feeling-button').addEventListener('click', () => feelingModal.classList.remove('hidden'));
                feelingModal.addEventListener('click', (e) => { if (e.target === feelingModal) { feelingModal.classList.add('hidden'); } });
                emojiGrid.addEventListener('click', (e) => {
                    if(e.target.classList.contains('emoji-button')) {
                        postContentInput.value += ` â€” feeling ${e.target.textContent}`;
                        feelingModal.classList.add('hidden');
                    }
                });

                const editProfileModal = document.getElementById('edit-profile-modal');
                let newPfpFile = null;
                document.getElementById('pfp-upload-input').addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        newPfpFile = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = (event) => { document.getElementById('edit-pfp-preview').src = event.target.result; };
                        reader.readAsDataURL(newPfpFile);
                    }
                });
                document.getElementById('cancel-edit-profile').addEventListener('click', () => editProfileModal.classList.add('hidden'));
                document.getElementById('save-edit-profile').addEventListener('click', async () => {
                    const newName = document.getElementById('edit-name-input').value.trim();
                    const updateData = {};
                    if (newName && newName !== userSnap.data().displayName) {
                        updateData.displayName = newName;
                    }
                    if (newPfpFile) {
                        const { url } = await uploadToCloudinary(newPfpFile);
                        updateData.photoURL = url;
                        newPfpFile = null;
                    }
                    if (Object.keys(updateData).length > 0) {
                        await updateDoc(userRef, updateData);
                    }
                    editProfileModal.classList.add('hidden');
                });

                const userMenu = document.getElementById('user-menu');
                const userMenuButton = document.getElementById('user-menu-button');
                const userMenuDropdown = document.getElementById('user-menu-dropdown');
                userMenuButton.addEventListener('click', (event) => { event.stopPropagation(); userMenuDropdown.classList.toggle('hidden'); });
                userMenuDropdown.addEventListener('click', (event) => { if (event.target.id === 'sign-out-button') { event.preventDefault(); signOut(auth); } });
                document.addEventListener('click', (event) => { if (!userMenuDropdown.classList.contains('hidden') && !userMenu.contains(event.target)) { userMenuDropdown.classList.add('hidden'); } });

                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('header-nav').classList.remove('hidden');
                document.getElementById('header-nav').classList.add('flex');

            } catch (error) {
                console.error("Fatal Error during app initialization:", error);
                const ls = document.getElementById('loading-screen');
                if (ls) {
                    ls.innerHTML = `<div class="text-center"><p class="text-red-400 text-xl font-semibold">A Fatal Error Occurred</p><p class="text-gray-400 mt-2">The application could not be loaded. Please try again later.</p><p class="text-gray-500 text-sm mt-4 font-mono bg-gray-800 p-2 rounded">Error: ${error.message}</p><button onclick="window.location.href='login.html'" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg">Return to Login</button></div>`;
                }
            }
        });
    </script>

</body>
</html>
